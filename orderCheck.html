<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml">
<html>

<head>
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
    <!-- X-UA-Compatible設置IE兼容模式 -->
    <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1">
    <!--RWD-->
    <meta name="viewport" content="width=device-width, initial-scale=1, user-scalable=0" />
    <meta name="author" content="萊茵巴赫科技" />
    <meta name="copyright" content="萊茵巴赫科技" />
    <!-- 結構化資料 SEO 與 meta 標籤 -->
    <meta property="og:title" content="柚美。柚好" />
    <meta property="og:url" content="">
    <meta property="og:image" content="要顯示的縮圖網址" />
    <meta property="og:description" content="網頁描述" />
    <link rel="stylesheet" href="css/normalize.css" />
    <link rel="stylesheet" href="css/style.css" />
    <title>柚美。柚好</title>
    <script src="js/jquery-3.2.1.js"></script>
    <script src="js/semantic.js"></script>
    <script src="js/jquery.elevatezoom.js"></script>
    <script src="js/jquery.twzipcode.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/js-cookie@2/src/js.cookie.min.js"></script>
</head>

<body style="background: none">
    <div id="orderCheckSidebar" class="ui left vertical inverted sidebar menu common">
        <div class="side-bar-header">
            <img src="images/side-bar-orderCheck-logo.png" class="img-fluid" />
        </div>
        <a class="item wonderfulType nav-link" href="story.html">美好故事
                            <h6 class="title">About&nbsp;Us</h6>
                        </a>
        <a class="item wonderfulType nav-link" href="news.html">最新消息
                            <h6 class="title">News</h6>
                        </a>
        <a class="item wonderfulType nav-link" href="productIndex.html">商品專區
                            <h6 class="title">Products</h6>
                        </a>
        <a class="item wonderfulType nav-link">相片底家
                            <h6 class="title">Photos</h6>
                        </a>
        <a class="item wonderfulType nav-link">美好問答
                            <h6 class="title">Q&A</h6>
                        </a>
        <a class="item wonderfulType nav-link">找尋美好
                            <h6 class="title">Find&nbsp;Us</h6>
                        </a>
        <div class="side-bar-link">
            <a id="side-loginIcon" class="icon-link">
                <img src="images/loginIcon-orderCheck.png" class="img-fluid" alt="" />
            </a>
            <a class="icon-link">
                <img src="images/cartIcon-orderCheck.png" class="img-fluid" alt="" />
            </a>
        </div>
        <div class="side-bar-footer">
            <img src="images/side-bar-footer-orderCheck.png" class="img-fluid" />
        </div>
    </div>

    <div class="pusher order-check-pusher">
        <header>
            <nav class="nav order-check-menu">
                <img src="images/order-bounce-logo1.png" class="img-fluid bounce-logo" alt="" />
                <div class="hamburger">&#9776;</div>
                <a href="index.html" class="order-check-site-logo">
                    <img src="images/webLogo-order-check.png" class="img-fluid" alt="" />
                </a>
                <img src="images/order-bounce-logo2.png" class="img-fluid bounce-logo" alt="" />
            </nav>
        </header>

        <script>
            cookiesData = [{
                'ProductID': 'P000000001',
                'ImgUrl': 'images/pomelo-2.png',
                'Name': '十斤裝手提文旦禮盒',
                'Qty': 3,
                'Price': 675,
            }, {
                'ProductID': 'P000000005',
                'ImgUrl': 'images/pomelo-3.png',
                'Name': '五斤裝手提文旦禮盒',
                'Qty': 1,
                'Price': 360,
            }]


            $(function() {
                orderCheckDynamicHeight();
                $(window).resize(function() {
                    orderCheckDynamicHeight();
                })


                // 測試用先建Cookie
                // Cookies.set('cart', JSON.stringify(cookiesData));
                if (typeof Cookies.get('cart') === 'undefined') {
                    console.log('no cookie');
                } else {
                    cookiesData = JSON.parse(Cookies.get('cart'));
                    initLoadOrderCart(cookiesData);
                }


            })

            // 控制三個欄位即使在螢幕寬度變更時， 動態調整區塊高度。
            function orderCheckDynamicHeight() {
                var orderCheckMenuHeight = $('.order-check-menu').height();
                $('.order-check').height($('body').height() - orderCheckMenuHeight);
            }


            $('.order-check-menu .hamburger').click(
                function() {
                    $('#orderCheckSidebar').sidebar('toggle');
                }
            );
            $('.order-check-menu .order-check-site-logo').hover(
                function() {
                    $(this).parent('.order-check-menu').children('.img-fluid').toggleClass('rotate360');
                },
                function() {
                    $(this).parent('.order-check-menu').children('.img-fluid').toggleClass('rotate360');
                }
            );
        </script>

        <div class="order-check">
            <div class="col-md-4 order-check-steps">
                <div class="locker"></div>
                <div class="section-header gray-bg">
                    <img src="images/order-check-step1-num.png" class="img-fluid" alt="" />
                    <img src="images/order-check-step1-head.png" class="img-fluid" alt="" />
                    <div class="title">我想買這些</div>
                </div>

                <button type="none" class="next-step">下一步</button>
            </div>
            <script>
                function initLoadOrderCart(cookieDataIn) {
                    var arry = [];
                    $.each(cookieDataIn, function(i, v) {
                        //左邊產品圖
                        var left = $('<div></div>').addClass('left').append($('<img/>').attr('src', v.ImgUrl).addClass('img-fluid'));


                        //右半部購買資訊
                        var title = $('<div></div>').addClass('title').text(v.Name);
                        var pidSpan = $('<h6></h6>').addClass('product-id').text(v.ProductID);
                        var priceSpan = $('<h6></h6>').addClass('cart-price').text(v.Price);

                        var addIcon = $('<img/>').addClass('img-fluid').attr('src', 'images/cart-content-add.png');
                        var minusIcon = $('<img/>').addClass('img-fluid miuns').attr('src', 'images/cart-content-minus.png');

                        var number = $('<div></div>').addClass('number').text(v.Qty);
                        var subtotal = $('<div></div>').addClass('subtotal').text(
                            function() {
                                if (parseInt(v.Qty) == 0) {
                                    return "$" + 0;
                                } else {
                                    return "$" + parseInt(v.Price) * (v.Qty);
                                }
                            }());

                        var clickCancel = $('<img/>').addClass('img-fluid').attr('src', 'images/cart-green-close.png');
                        var right = $('<div></div>').addClass('right').append([title, pidSpan, priceSpan, $('<div></div>').addClass('number-select').append([addIcon, number, minusIcon, subtotal, clickCancel])])

                        var confirmDelete = $('<div></div>').addClass('confirm-delete').append([
                            $('<img/>').addClass('img-fluid').attr('src', 'images/cart-delete-icon.png'),
                            $('<div></div>').addClass('title').text('確認刪除')
                        ]);

                        var cancelDelete = $('<div></div>').addClass('cancel-delete').append([
                            $('<img/>').addClass('img-fluid').attr('src', 'images/cart-cancel-icon.png'),
                            $('<div></div>').addClass('title').text('取消刪除')
                        ])

                        var orderCheckProducts = $('<div></div>').addClass('order-check-products').append([left, right, $('<div></div>').addClass('order-check-delete').append([confirmDelete, cancelDelete])])

                        arry.push(orderCheckProducts);
                    })

                    $('.order-check .order-check-steps:nth-child(1) .section-header').after(arry);
                    orderCartCustomEffect();
                }


                function orderCartCustomEffect() {
                    $('.order-check-products .right .number-select .img-fluid:first-child').hover(
                        function() {
                            $(this).attr('src', 'images/cart-content-add-hover.png');
                        },
                        function() {
                            $(this).attr('src', 'images/cart-content-add.png');
                        }
                    );

                    $('.order-check-products .right .number-select .img-fluid:nth-child(3)').hover(
                        function() {
                            $(this).attr('src', 'images/cart-content-minus-hover.png');
                        },
                        function() {
                            $(this).attr('src', 'images/cart-content-minus.png');
                        }
                    );
                    $('.order-check-products .right .number-select .img-fluid:last-child').hover(
                        function() {
                            $(this).attr('src', 'images/cart-red-close.png');
                        },
                        function() {
                            $(this).attr('src', 'images/cart-green-close.png');
                        }
                    );

                    $('.order-check-products .right .number-select .img-fluid:last-child').click(
                        function() {
                            $(this).parents('.order-check-products').children('.order-check-delete').animate({
                                'left': 0
                            }, 500)
                        }
                    );

                    $('.order-check-products .right .number-select .img-fluid:first-child').click(
                        function() {
                            var num = parseInt($(this).parent('.number-select').children('.number').text()) + 1;
                            $(this).parent('.number-select').children('.number').text(num);
                            var price = parseInt($(this).parents('.right').children('.cart-price').text());
                            $(this).parent('.number-select').children('.subtotal').text(
                                function() {
                                    return '$' + num * price;
                                }()
                            )
                        }
                    );
                    $('.order-check-products .right .number-select .img-fluid:nth-child(3)').click(
                        function() {
                            var num = parseInt($(this).parent('.number-select').children('.number').text()) - 1;
                            if (num == 0) {
                                num = 1;
                            }
                            $(this).parent('.number-select').children('.number').text(num);
                            var price = parseInt($(this).parents('.right').children('.cart-price').text());
                            $(this).parent('.number-select').children('.subtotal').text(
                                function() {
                                    return '$' + num * price;
                                }()
                            )
                        }
                    );
                    //刪除單一品項相關特效
                    $('.confirm-delete').hover(
                        function() {
                            $(this).children('.img-fluid').attr('src', 'images/cart-delete-icon-hover.png');
                        },
                        function() {
                            $(this).children('.img-fluid').attr('src', 'images/cart-delete-icon.png');
                        }
                    );
                    $('.cancel-delete').hover(
                        function() {
                            $(this).children('.img-fluid').attr('src', 'images/cart-cancel-icon-hover.png');
                        },
                        function() {
                            $(this).children('.img-fluid').attr('src', 'images/cart-cancel-icon.png');
                        }
                    );

                    $('.cancel-delete').click(
                        function() {
                            $(this).parent('.order-check-delete').animate({
                                'left': "-120%"
                            }, 500)
                        }
                    );
                    // 確定刪除單一商品品項
                    $('.order-check-delete .confirm-delete').click(
                        function() {
                            $(this).parents('.order-check-products').remove();
                        }
                    );
                };

                $('.order-check-steps .next-step').click(
                    function() {
                        orderCheckResetCookie();
                        $(this).parents('.order-check-steps').find('.section-header').removeClass('gray-bg');
                        $(this).parents('.order-check-steps').find('.section-header .img-fluid:first-child').attr('src', 'images/order-check-step1-num-lock.png');
                        $(this).parents('.order-check-steps').find('.section-header .img-fluid:nth-child(2)').attr('src', 'images/order-check-step1-head-lock.png');
                        $(this).parents('.order-check-steps').find('.locker').addClass('active');
                    }
                )


                function orderCheckResetCookie() {
                    if ($('.order-check-products').length == 0) {
                        Cookies.remove("cart");
                    } else {
                        var CookieArry = [];
                        $('.order-check-products').each(
                            function() {
                                var jsonTemp = {
                                    'ProductID': $(this).find('.product-id').text(),
                                    'ImgUrl': $(this).find('.left .img-fluid').attr('src'),
                                    'Name': $(this).find('.right .title').text(),
                                    'Price': $(this).find('.cart-price').text(),
                                    'Qty': $(this).find('.number').text()
                                }
                                CookieArry.push(jsonTemp);
                            }
                        )
                        Cookies.set('cart', CookieArry);
                        // console.log(Cookies.get('cart'));
                    }
                }
            </script>
            <div class="col-md-4 order-check-steps">
                <div class="locker"></div>
                <div class="section-header gray-bg">
                    <img src="images/order-check-step2-num.png" class="img-fluid" alt="" style="margin-left: 20%" />
                    <img src="images/order-check-step1-head.png" class="img-fluid" alt="" style="opacity: 0; margin: 0" />
                    <div class="title" style="margin-left: -8%">我想寄到這</div>
                </div>
                <div class="orderer-info">
                    <img src="images/orderer-info.png" class="img-fluid" alt="" />
                    <div class="right">
                        <label>訂購人</label><input name="name" type="text" /><br/>
                        <label>連絡電話</label><input name="cell" type="text" />
                    </div>
                </div>

                <div class="delivery">
                    <div class="next-reciepts">
                        <img src="images/green-add-icon.png" class="img-fluid" alt="" />
                        <span>新增收件人</span>
                    </div>
                </div>

                <script>
                    $(function() {
                        var maxQtys = [];
                        $.each(cookiesData, function(i, v) {
                            maxQtys.push($('<span>/span>').text(v.Qty));
                        })

                        $('.maxQty').append(maxQtys);
                    })



                    function deleteReciept(e) {
                        if ($(e).parents('.reciepts').find(' .header span').text() == '1') {
                            console.log('不可以刪除');
                        } else {
                            $(e).parents('.reciepts').remove();
                            var max = $('.order-check-steps .delivery .reciepts').length;
                            $('.order-check-steps .delivery .reciepts').each(
                                function(i, v) {
                                    $(this).find('.header span').text(i + 1);
                                }
                            )
                        }
                    }

                    function deliverySlidedown(e) {
                        if ($(e).attr('src') == 'images/green-down.png') {
                            $(e).attr('src', 'images/green-up.png');
                            $(e).parents('.reciepts').find('.reciept-product').slideDown(500);
                        } else {
                            $(e).attr('src', 'images/green-down.png');
                            $(e).parents('.reciepts').find('.reciept-product').slideUp(500);
                        }
                    };

                    // 商品分配數量：增加1
                    function productAsignAdd(e) {
                        var max = parseInt($(e).parents('.products').children('.maxQty').text());
                        var num = parseInt($(e).parent('.number-select').children('.number').text()) + 1;
                        // 單一分配人超過總量的控制
                        if (num > max) {
                            num = max;
                            $('#deliveryNotice1').modal(
                                'show', {
                                    transition: 'scale',
                                    duration: 1
                                }
                            )
                        }
                        $(e).parent('.number-select').children('.number').text(num);
                        //多個分配人超過總量的控制
                        var total = productAsignAudit(e);
                        if (total > max) {
                            $('#deliveryNotice1').modal(
                                'show', {
                                    transition: 'scale',
                                    duration: 1
                                }
                            )
                            $(e).parent('.number-select').children('.number').text(num - 1);
                        }
                        var fee = deliveryFeeAudit(e);
                        $(e).parents('.reciepts').find('.fee span').text(fee);
                    };

                    // 商品分配數量：減少1
                    function productAsignMinus(e) {
                        var num = parseInt($(e).parent('.number-select').children('.number').text()) - 1;
                        if (num < 0) {
                            num = 0;
                        }
                        $(e).parent('.number-select').children('.number').text(num);
                        var fee = deliveryFeeAudit(e);
                        $(e).parents('.reciepts').find('.fee span').text(fee);
                    };

                    // 商品分配數量檢核
                    function productAsignAudit(e) {
                        var ElementIndex = $(e).parents('.products').index();
                        var total = 0;
                        $('.delivery .reciepts').each(
                            function() {
                                total = total + parseInt($(this).find('.product-asign .products:nth-child(' + (ElementIndex + 1) + ')  .number').text());
                            }
                        )
                        return total;
                    };

                    //運費檢核
                    function deliveryFeeAudit(e) {
                        var fee = 0;
                        var subtotal = 0;
                        $(e).parents('.product-asign').find('.products').each(
                            function() {
                                var price = cookiesData[$(this).index()].Price;
                                subtotal = subtotal + (parseInt($(this).find('.number').text()) * price);
                            }
                        );
                        console.log('sub:' + subtotal);
                        // 免運金額與運費設置
                        if (subtotal >= 1500) {
                            fee = 0;
                        } else {
                            fee = 60;
                        }
                        return fee;
                    };

                    //結帳前分配完全檢核
                    function deliveryFullyAudit(e) {
                        var recieptMaxIndex = $('.reciepts').length;
                        var productMaxIndex = $('.reciepts:nth-child(1) .product-asign .products').length;
                        var qtyArry = [];
                        for (var y = 1; y <= productMaxIndex; y++) {
                            var num = 0;
                            for (var x = 1; x <= recieptMaxIndex; x++) {
                                num = num + parseInt($('.reciepts:nth-child(' + x + ') .product-asign .products:nth-child(' + y + ') .number').text());
                            }
                            qtyArry.push(num);
                        }
                        console.log(qtyArry);
                        var flag = false;
                        $.each(JSON.parse(Cookies.get('cart')), function(i, v) {
                            if (v.Qty != qtyArry[i]) {
                                flag = true;
                                return null;
                            }
                        });
                        if (flag) {
                            $('#deliveryNotice2').modal('show'), {
                                transition: 'scale',
                                duration: 1
                            };
                        } else {
                            $(e).parents('.order-check-steps').find('.section-header').removeClass('gray-bg');
                            $(e).parents('.order-check-steps').find('.section-header .img-fluid:first-child').attr('src', 'images/order-check-step2-num-lock.png');
                            $(e).parents('.order-check-steps').find('.locker').addClass('active');
                        };
                    }

                    function orderCheckDeliveryEffect() {
                        $('.twzipcode').twzipcode();

                        $('.reciepts .number-select .img-fluid:first-child').hover(
                            function() {
                                $(this).attr('src', 'images/cart-content-add-hover.png');
                            },
                            function() {
                                $(this).attr('src', 'images/cart-content-add.png');
                            }
                        );

                        $('.reciepts .number-select .img-fluid:last-child').hover(
                            function() {
                                $(this).attr('src', 'images/cart-content-minus-hover.png');
                            },
                            function() {
                                $(this).attr('src', 'images/cart-content-minus.png');
                            }
                        );

                        $('.order-check-steps .delivery .reciepts .delete-reciept').hover(
                            function() {
                                $(this).children('.img-fluid').attr('src', 'images/cart-red-close.png');
                            },
                            function() {
                                $(this).children('.img-fluid').attr('src', 'images/cart-green-close.png');
                            }
                        )
                    };



                    // 增加收件人與商品配送資訊
                    function createReciepts(CookiesDataIn) {
                        //Delete reciept button
                        var deleteButton = $('<div></div>').attr('onclick', 'deleteReciept(this)').addClass('delete-reciept').append($('<img/>').attr('src', 'images/cart-green-close.png').addClass('img-fluid'));

                        //Header
                        var header = $('<div></div>').addClass('header').append(
                            [
                                $('<img/>').addClass('img-fluid').attr('src', 'images/reciept-icon.png'),
                                $('<span></span>').text(
                                    function() {
                                        return $('.delivery .reciepts').length + 1;
                                    }()
                                ),
                                $('<div></div>').addClass('title').text('收件人與配送商品'),
                                $('<img/>').addClass('img-fluid press-slide').attr({
                                    'src': 'images/green-down.png',
                                    'onclick': 'deliverySlidedown(this)'
                                })
                            ]
                        );

                        //reciept-product分區區塊1
                        var recieptsInfo = $('<div></div>').addClass('reciepts-info').append([
                            $('<label></label>').text('收件人'),
                            $('<input/>').attr({
                                'type': 'text',
                                'name': 'recieptName'
                            }),
                            $('<br/>'),
                            $('<label></label>').text('連絡電話'),
                            $('<input/>').attr({
                                'type': 'text',
                                'name': 'recieptCell'
                            }),
                            $('<br/>'),
                            $('<label></label>').text('收件地址').css('margin-bottom', '-12%'),
                            $('<div></div>').addClass('twzipcode').append([
                                $('<div><div>').attr({
                                    'data-role': 'zipcode',
                                    'data-readonly': '1',
                                    'data-style': 'zip'
                                }),
                                $('<div><div>').attr({
                                    'data-role': 'county',
                                    'data-name': '表單名稱',
                                    'data-style': 'country'
                                }),
                                $('<div><div>').attr({
                                    'data-role': 'district',
                                    'data-name': 'district[]',
                                    'data-style': 'district'
                                })
                            ]),
                            $('<input/>').addClass('addr').attr({
                                'name': 'addr',
                                'type': 'text'
                            })
                        ]);

                        //reciept-product分區區塊2
                        var hr = $('<div></div>').addClass('hr');

                        var products = [];
                        $.each(CookiesDataIn, function(i, v) {
                            var product = $('<div></div>').addClass('products').append([
                                $('<div></div>').addClass('title').text(v.Name),
                                $('<div></div>').addClass('maxQty').text(v.Qty),
                                $('<div></div>').addClass('number-select').append([
                                    $('<img/>').addClass('img-fluid').attr({
                                        'src': 'images/cart-content-add.png',
                                        'onclick': 'productAsignAdd(this)'
                                    }),
                                    $('<div></div>').addClass('number').text(
                                        function() {
                                            if ($('.order-check-steps .delivery .reciepts').length == 0) {
                                                return v.Qty;
                                            } else {
                                                return 0;
                                            }
                                        }()
                                    ),
                                    $('<img/>').addClass('img-fluid').attr({
                                        'src': 'images/cart-content-minus.png',
                                        'onclick': 'productAsignMinus(this)'
                                    })
                                ])
                            ]);
                            products.push(product);
                        });
                        //reciept-product分區區塊3
                        var productAsign = $('<div></div>').addClass('product-asign').append(products);

                        //reciept-product分區區塊4
                        var fee = $('<div></div>').addClass('fee').append([
                            $('<label></label>').text('運費：$'),
                            $('<span></span>').text(0)
                        ]);
                        //結合reciept-product
                        var recieptProduct = $('<div></div>').addClass('reciept-product').append([recieptsInfo, hr, productAsign, $('<div></div>').addClass('hr'), fee]);


                        var reciepts = $('<div></div>').addClass('reciepts').append([deleteButton, header, recieptProduct]);
                        $('.delivery .next-reciepts').before(reciepts);
                        orderCheckDeliveryEffect();
                    };

                    $(function() {
                        createReciepts(cookiesData);
                    })

                    $('.delivery .next-reciepts').click(
                        function() {
                            createReciepts(cookiesData);
                        }
                    )
                </script>


                <button type="none" class="next-step" onclick="deliveryFullyAudit(this)">下一步</button>
                <img src="images/order-check-step2-bg.png" class="img-fluid" />
            </div>

            <div class="col-md-4 order-check-steps">
                <div class="locker"></div>
                <div class="section-header">
                    <img src="images/order-check-step3-num-lock.png" class="img-fluid" alt="" />
                    <div class="title">我要付錢了</div>
                    <img src="images/order-check-step3-head-lock.png" class="img-fluid" alt="" />
                </div>

                <button type="none" class="next-step">下一步</button>
            </div>


        </div>

        <!--提示分數量Modal-->
        <div id="deliveryNotice1" class="ui modal">
            <div class="">
                <div class="title">超過該商品訂購數量。</div>
            </div>
            <button class="" type="none">確定</button>
        </div>
        <script>
            $('#deliveryNotice1 button').click(
                function() {
                    $(this).parent('#deliveryNotice1').modal('hide');
                }
            )
        </script>
        <!--分數不足Modal-->
        <div id="deliveryNotice2" class="ui modal">
            <div class="">
                <div class="title">尚有商品未分配。</div>
            </div>
            <button class="" type="none">確定</button>
        </div>
        <script>
            $('#deliveryNotice2 button').click(
                function() {
                    $(this).parent('#deliveryNotice2').modal('hide');
                }
            )
        </script>
    </div>


</body>

</html>