<html>

<head>
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
    <!-- X-UA-Compatible設置IE兼容模式 -->
    <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1">
    <!--RWD-->
    <meta name="viewport" content="width=device-width, initial-scale=1, user-scalable=0" />
    <meta name="author" content="萊茵巴赫科技" />
    <meta name="copyright" content="萊茵巴赫科技" />
    <!-- 結構化資料 SEO 與 meta 標籤 -->
    <meta property="og:title" content="柚美。柚好" />
    <meta property="og:url" content="">
    <meta property="og:image" content="要顯示的縮圖網址" />
    <meta property="og:description" content="網頁描述" />
    <link rel="stylesheet" href="css/normalize.css" />
    <link rel="stylesheet" href="css/style.css" />
    <title>柚美。柚好</title>
    <script src="js/jquery-3.2.1.js"></script>
    <script src="js/semantic.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/js-cookie@2/src/js.cookie.min.js"></script>
    <script src="js/reinbachCommon.js"></script>
</head>

<body style="background: none">
    <!--共用樣式區，sidebar-->
    <div id="memberSidebar" class="ui left vertical inverted sidebar menu">
        <div class="header">美好會員中心</div>
        <div class="sidebar-logo">
            <img src="images/member-sidebar-logo.png" class="img-fluid" alt="" />
        </div>
        <div class="section-header">會員資料管理</div>
        <div class="profile-manage">
            <a class="item nav-link" href="memberProfile.html">個人資料修改</a>
            <a class="item nav-link" href="memberResetPwd.html">密碼修改</a>
        </div>
        <div class="section-header">會員訂單管理</div>
        <div class="order-manage">
            <a class="item nav-link" href="memberMyOrder.html">我的訂單</a>
            <a class="item nav-link" href="memberOrderReturnIndex.html">退貨申請</a>
            <a class="item nav-link" href="memberOrderCancel.html">取消訂單</a>
        </div>
        <div class="section-header">紅利與購物金</div>
        <div class="bonus-funds-manage">
            <a class="item nav-link" href="memberBonus.html">紅利回饋</a>
            <a class="item nav-link" href="memberFunds.html">購物金</a>
        </div>
        <div class="section-header">購物小幫手</div>
        <div class="order-help">
            <a class="item nav-link" href="memberHelper1.html">紅利回饋與購物金說明</a>
            <a class="item nav-link" href="memberHelper2.html">購物流程</a>
            <a class="item nav-link" href="memberHelper3.html">服務條款與隱私政策</a>
        </div>
    </div>
    <script>
        $('#memberSidebar .item').hover(
            function() {
                $(this).children('.img-fluid').css('opacity', '1');
            },
            function() {
                $(this).children('.img-fluid').css('opacity', '0');
            }
        );
    </script>

    <div class="pusher" style="position:relative">
        <!--共用樣式區，Header-->
        <header>
            <nav class="nav member-common-menu">
                <img src="images/order-bounce-logo1.png" class="img-fluid bounce-logo" alt="" />
                <div class="hamburger">&#9776;</div>
                <a href="index.html" class="order-check-site-logo">
                    <img src="images/webLogo-order-check.png" class="img-fluid" alt="" />
                </a>
                <img src="images/order-bounce-logo2.png" class="img-fluid bounce-logo" alt="" />
            </nav>
        </header>
        <script>
            $('.member-common-menu .hamburger').click(
                function() {
                    $('#memberSidebar').sidebar('toggle');
                }
            );
            $('.member-common-menu .order-check-site-logo').hover(
                function() {
                    $(this).parent('.member-common-menu').children('.bounce-logo').toggleClass('rotate360');
                },
                function() {
                    $(this).parent('.member-common-menu').children('.bounce-logo').toggleClass('rotate360');
                }
            );
        </script>


        <div class="container return-step4 return-step-common">
            <div class="steps-bar">
                <img src="images/return-step-bar-4.png" class="img-fluid" alt="" />
                <a href="" class="back-return-step">Step1選擇商品</a>
                <a href="" class="back-return-step">Step2商品處理方式</a>
                <a href="" class="back-return-step">Step3退款資料填寫</a>
            </div>
            <div class="title">請確認下列資訊是否無誤</div>
            <div class="sub-title">退款明細：</div>
            <table class="confirm-return">
                <tr>
                    <td class="index">1.</td>
                    <td class="product-img">
                        <img src="images/pomelo-2.png" class="img-fluid" alt="" />
                    </td>
                    <td class="return-product">
                        <div class="title">P000000001</div>
                        <div class="title">十斤裝手提文旦禮盒(嚴選40年老欉)</div>
                        <div class="title">售價：$<span>750</span></div>
                        <div class="title">數量：<span>3</span></div>
                    </td>
                    <td class="return-receipt">
                        <div class="title">收件人：<span>松島璁</span></div>
                        <div class="title">連絡電話：<span>0910055885</span></div>
                        <div class="title">收貨地址：<span>台北市中正區羅斯福路路二段125巷235號7樓</span></div>
                    </td>
                </tr>
            </table>
            <div class="sub-title retunr-type">退款方式：<span>匯款</span></div>
            <div class="refund-info">

            </div>

            <button class="submit" type="none">送出申請</button>
        </div>

        <script>
            var testMeberOrderPayAccountRecrod = [{
                "OrderID": location.search.substr(location.search.indexOf('=') + 1),
                "Total": 3588,
                "Discount": "550",
                "Bank": "013",
                "Account": "95587251470025",
                "PayName": "松島聰",
                "PayTime": "2018-07-10"
            }];

            $(function() {
                returnStepsBarHeight();
                generateUrlOfReturnSteps();
                console.log(JSON.parse(Cookies.get('returnExchange')));
                console.log(Cookies.get('refundType'));
                memberOrderPayAccountRecrod = testMeberOrderPayAccountRecrod;
                // $.post('<c:url value="/order/getOneOrder">', {
                //     "orderID": location.search.substr(location.search.indexOf('=') + 1)
                // }, function(data) {
                //     memberOrderPayAccountRecrod = data;
                // });
                var returnConfirmDataArry = JSON.parse(Cookies.get('returnExchange'));
                loadReturnConfirmData(returnConfirmDataArry, memberOrderPayAccountRecrod);
            });


            // 設定Step Bar連結的高度
            function returnStepsBarHeight() {
                $('.container.return-step-common .steps-bar .back-return-step').css('height', function() {
                    return $('.container.return-step-common .steps-bar .img-fluid').height();
                }());
            };

            // 設定Step Bar的每一個連結導向
            function generateUrlOfReturnSteps() {
                let orderID = location.search.substr(location.search.indexOf('=') + 1);
                $('.container.return-step-common .steps-bar .back-return-step').each(function(i, v) {
                    $(this).attr('href', '/memberOrderReturnStep' + (i + 1) + '.html?orderID=' + orderID);
                });
            };

            //動態載入確認退貨資料
            function loadReturnConfirmData(jsonDataIn, jsonDataIn2) {
                // 先清空表格裡面的退貨資料
                $('.container.return-step4 .confirm-return').html('');
                let trArry = [];
                //退款總額
                let returnTotal = 0;
                $.each(jsonDataIn, function(i, v) {
                    returnTotal = returnTotal + parseInt(v.returnQty) * parseInt(v.returnProductPrice);
                    let trow = $('<tr></tr>').append([
                        $('<td></td>').addClass('index').text(i + 1 + "."),
                        $('<td></td>').addClass('product-img').append($('<img/>').attr('src', v.returnProductImg).addClass('img-fluid')),
                        $('<td></td>').addClass('return-product').append([
                            $('<div></div>').addClass('title').text(v.returnProductID),
                            $('<div></div>').addClass('title').text(v.returnProductName),
                            $('<div></div>').addClass('title').text('售價：$').append($('<span></span>').text(v.returnProductPrice)),
                            $('<div></div>').addClass('title').text('數量：').append($('<span></span>').text(v.returnQty))
                        ]),
                        $('<td></td>').addClass('return-receipt').append([
                            $('<div></div>').addClass('title').text('收件人：').append($('<span>/span>').text(v.deliveryName)),
                            $('<div></div>').addClass('title').text('聯絡電話').append($('<span>/span>').text(v.deliveryCell)),
                            $('<div></div>').addClass('title').text('收貨地址：').append($('<span>/span>').text(v.deliveryAddr))
                        ])
                    ])
                    trArry.push(trow);
                });
                console.log(returnTotal);
                $('.container.return-step4 .confirm-return').append(trArry);
                $('.container.return-step4 .retunr-type span').text(Cookies.get('refundType'));
                $('.refund-info').html('');
                if (Cookies.get('refundType') === "匯款") {
                    $('.refund-info').append([
                        $('<div></div>').addClass('title').text('銀行代碼:').append($('<span></span>').text(jsonDataIn2[0].Bank)),
                        $('<div></div>').addClass('title').text('帳號:').append($('<span></span>').text(jsonDataIn2[0].Account)),
                        $('<div></div>').addClass('title').text('戶名:').append($('<span></span>').text(jsonDataIn2[0].PayName)),
                        $('<div></div>').addClass('title refund-total').text('退款金額:$').append($('<span></span>').text(returnTotal))
                    ]);
                } else {
                    $('.refund-info').append($('<div></div>').addClass('title refund-total').text('退款金額:$').append($('<span></span>').text(returnTotal)));
                };
            };

            $('.container.return-step4 .submit').click(
                function() {
                    let returnExchangeFull = JSON.parse(Cookies.get('returnExchange'));
                    let returnExchange = [];
                    $.each(returnExchangeFull, function(i, v) {
                        let objTemp = {
                            'deliveryID': v.deliveryID,
                            'returnQty': v.returnQty,
                            'refundType': v.refundType
                        }
                        returnExchange.push(objTemp);
                    });
                    let dataList = {
                        "returnExchange": returnExchange
                    };
                    console.log(dataList);
                    $.ajax({
                        url: '<c:url value="/user/return/returns"/>',
                        type: "POST",
                        dataType: "json",
                        data: JSON.stringify(dataList),
                        success: function(data) {
                            if (data.success === "申請成功") {
                                $('#returnStepNotice .title').html('我們會儘速處理您的申請，<br/>退款完成後將會以e-mail通知您。');
                                $('#returnStepNotice').modal('show');
                            } else if (data.fail === "申請失敗") {
                                $('#returnStepNotice .title').html('申請失敗，請洽網站管理員。');
                                $('#returnStepNotice').modal('show');
                            } else if (data.fail === "申請退貨數量大於訂購量，請洽詢賣家") {
                                $('#returnStepNotice .title').html('申請退貨數量大於訂購量，<br/>請洽詢網站管理者。');
                                $('#returnStepNotice').modal('show');
                            }
                        },
                        error: function() {
                            $('#returnStepNotice .title').html('無法送出申請。<br/>請確認瀏覽器允許Cookie的存取。');
                            $('#returnStepNotice').modal('show');
                        }
                    });
                }
            );
        </script>


        <!--半共用樣式區，Footer-->
        <footer class=" member-common-footer">
            <div class="member-order-return-step-common step2">
                <img src="images/return-animation-1.png" class="img-fluid" alt="" />
                <img src="images/dark-cloud.png" class="img-fluid" alt="" />
                <img src="images/rain-light.png" class="img-fluid" alt="" />
                <img src="images/rain-heavy.png" class="img-fluid" alt="" />
                <img src="images/rain-light.png" class="img-fluid" alt="" />
                <img src="images/rain-heavy.png" class="img-fluid" alt="" />
                <img src="images/rain-light.png" class="img-fluid" alt="" />
                <img src="images/rain-heavy.png" class="img-fluid" alt="" />
                <img src="images/member-myorder-footer-bg.png " class="img-fluid " alt=" " />
                <div class="icon-link ">
                    <a href=" " class=" ">
                        <img src="images/icon-fb.png " class="img-fluid " alt=" " />
                    </a>
                    <a href=" " class=" ">
                        <img src="images/icon-ig.png " class="img-fluid " alt=" " />
                    </a>
                    <a href=" " class=" ">
                        <img src="images/icon-utube.png " class="img-fluid " alt=" " />
                    </a>
                </div>
                <div class="footer-title ">
                    <div class="title ">會員訂單管理</div>
                    <div class="title ">退貨申請：商品處理方式</div>
                </div>
                <div class="footer-link ">
                    <a href="news.html " class="wonderfulType nav-link ">
                        <div class="title ">最新消息</div>
                        <div class="title ">News</div>
                    </a>
                    <a href="productIndex.html " class="wonderfulType nav-link ">
                        <div class="title ">商品專區</div>
                        <div class="title ">Products</div>
                    </a>
                    <a href=" " class="wonderfulType nav-link ">
                        <div class="title ">相片底家</div>
                        <div class="title ">Photos</div>
                    </a>
                    <a href="story.html " class="wonderfulType nav-link ">
                        <div class="title ">美好故事</div>
                        <div class="title ">About&nbsp;Us</div>
                    </a>
                    <a href=" " class="wonderfulType nav-link ">
                        <div class="title ">美好問答</div>
                        <div class="title ">Q&A</div>
                    </a>
                    <a href="contact.html " class="wonderfulType nav-link ">
                        <div class="title ">找尋美好</div>
                        <div class="title ">Find&nbsp;Us</div>
                    </a>
                </div>
            </div>
        </footer>
        <script>
            $('.member-order-return-step-common .footer-link .nav-link').hover(
                function() {
                    $(this).children('.title:last-child').css('opacity', "1 ");
                },
                function() {
                    $(this).children('.title:last-child').css('opacity', "0 ");
                }
            );
        </script>
    </div>
    <div class="ui modal" id="returnStepNotice">
        <div class="title"></div>
        <hr />
        <button type="none" class="submit">關閉</button>
    </div>
    <script>
        $('#returnStepNotice .submit').click(
            function() {
                $('#returnStepNotice').modal('hide');
            }
        );
    </script>
</body>

</html>